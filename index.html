<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>dub User Analysis Tool</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        
        /* Container for side-by-side widgets (Upload UI) */
        .main-widgets-container {
            display: flex;
            gap: 20px;
            justify-content: center;
            align-items: flex-start;
            margin: 20px 0;
            flex-wrap: wrap; 
        }
        
        .tool-container {
            width: 450px;
        }
        
        /* Credentials Modal Styling */
        .credentials-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .credentials-content {
            background-color: white;
            margin: 8% auto;
            padding: 30px;
            border-radius: 10px;
            width: 500px;
            max-width: 90%;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            position: relative;
        }
        
        .credentials-header {
            margin-bottom: 20px;
            border-bottom: 2px solid #6f42c1;
            padding-bottom: 10px;
        }
        
        .credentials-header h2 {
            margin: 0;
            color: #6f42c1;
        }
        
        .credential-field {
            margin-bottom: 20px;
        }
        
        .credential-field label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
        }
        
        .credential-field input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        .credential-field input:focus {
            outline: none;
            border-color: #6f42c1;
            box-shadow: 0 0 0 2px rgba(111, 66, 193, 0.1);
        }
        
        .credential-field small {
            color: #6c757d;
            display: block;
            margin-top: 5px;
        }
        
        .credentials-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 25px;
        }
        
        .cred-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .cred-btn-save {
            background: #6f42c1;
            color: white;
        }
        
        .cred-btn-save:hover {
            background: #5a32a3;
        }
        
        .cred-btn-cancel {
            background: #6c757d;
            color: white;
        }
        
        .cred-btn-cancel:hover {
            background: #5a6268;
        }
        
        .cred-btn-clear {
            background: #dc3545;
            color: white;
        }
        
        .cred-btn-clear:hover {
            background: #c82333;
        }
        
        .close-modal {
            position: absolute;
            right: 15px;
            top: 15px;
            font-size: 28px;
            font-weight: bold;
            color: #999;
            cursor: pointer;
            line-height: 20px;
        }
        
        .close-modal:hover {
            color: #333;
        }
        
        .test-status {
            padding: 10px;
            margin-top: 15px;
            border-radius: 4px;
            text-align: center;
            display: none;
        }
        
        .test-status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .test-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        /* Info box for credentials */
        .info-box {
            background: #f8f9fa;
            border-left: 4px solid #6f42c1;
            padding: 12px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        
        .info-box h4 {
            margin: 0 0 8px 0;
            color: #6f42c1;
            font-size: 14px;
        }
        
        .info-box p {
            margin: 0;
            font-size: 13px;
            color: #555;
            line-height: 1.5;
        }
        
        .info-box a {
            color: #6f42c1;
            text-decoration: none;
        }
        
        .info-box a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    
    <div class="main-widgets-container">
        <div id="dataMergerContainer" class="tool-container"></div>
        
        <div id="analysisToolContainer" class="tool-container"></div>
    </div>
    
    <div id="analysisResultsOutputContainer" style="margin-top: 40px;"></div>

    <!-- Credentials Modal -->
    <div id="credentialsModal" class="credentials-modal">
        <div class="credentials-content">
            <span class="close-modal" onclick="closeCredentialsModal()">&times;</span>
            
            <div class="credentials-header">
                <h2>Mixpanel Configuration</h2>
            </div>
            
            <div class="info-box">
                <h4>How to find your credentials:</h4>
                <p>
                    1. Go to your <a href="https://mixpanel.com/project/settings" target="_blank">Mixpanel Project Settings</a><br>
                    2. Find your <strong>Project Token</strong> in the Overview section<br>
                    3. Find your <strong>API Secret</strong> in the Service Accounts section
                </p>
            </div>
            
            <div class="credential-field">
                <label for="projectToken">Project Token</label>
                <input type="text" id="projectToken" placeholder="e.g., 669eda949f33cf988d2bbe77bc961c34">
                <small>Found in Project Settings → Overview</small>
            </div>
            
            <div class="credential-field">
                <label for="apiSecret">API Secret</label>
                <input type="password" id="apiSecret" placeholder="e.g., 8f48f2d2deb57702d7c062c2067c9882">
                <small>Found in Project Settings → Service Accounts</small>
            </div>
            
            <div id="testStatus" class="test-status"></div>
            
            <div class="credentials-buttons">
                <button class="cred-btn cred-btn-clear" onclick="clearCredentials()">Clear Credentials</button>
                <button class="cred-btn cred-btn-cancel" onclick="closeCredentialsModal()">Cancel</button>
                <button class="cred-btn cred-btn-save" onclick="saveCredentials()">Save & Test</button>
            </div>
        </div>
    </div>

    <script src="mixpanel_sync.js"></script>
    <script src="data_merger.js"></script>
    <script src="analysis_tool.js"></script>
    
    <script>
        // Credentials Modal Functions
        function showCredentialsModal() {
            const modal = document.getElementById('credentialsModal');
            modal.style.display = 'block';
            
            // Pre-fill with existing credentials if available
            if (window.MixpanelSync) {
                const sync = new window.MixpanelSync();
                document.getElementById('projectToken').value = sync.projectToken || '';
                document.getElementById('apiSecret').value = sync.apiSecret || '';
            }
            
            // Clear test status
            const testStatus = document.getElementById('testStatus');
            testStatus.style.display = 'none';
        }
        
        function closeCredentialsModal() {
            document.getElementById('credentialsModal').style.display = 'none';
        }
        
        async function saveCredentials() {
            const projectToken = document.getElementById('projectToken').value.trim();
            const apiSecret = document.getElementById('apiSecret').value.trim();
            const testStatus = document.getElementById('testStatus');
            
            if (!projectToken || !apiSecret) {
                testStatus.className = 'test-status error';
                testStatus.textContent = 'Please enter both Project Token and API Secret';
                testStatus.style.display = 'block';
                return;
            }
            
            // Save credentials
            const sync = new window.MixpanelSync();
            sync.saveCredentials(projectToken, apiSecret);
            
            // Test connection
            testStatus.className = 'test-status';
            testStatus.textContent = 'Testing connection...';
            testStatus.style.display = 'block';
            
            try {
                const isValid = await sync.testConnection();
                
                if (isValid) {
                    testStatus.className = 'test-status success';
                    testStatus.textContent = '✓ Connection successful! Credentials saved.';
                    
                    // Update status indicator
                    updateCredentialsStatus();
                    
                    // Close modal after 2 seconds
                    setTimeout(() => {
                        closeCredentialsModal();
                    }, 2000);
                } else {
                    testStatus.className = 'test-status error';
                    testStatus.textContent = '✗ Invalid credentials. Please check and try again.';
                }
            } catch (error) {
                testStatus.className = 'test-status error';
                testStatus.textContent = '✗ Connection failed: ' + error.message;
            }
        }
        
        function clearCredentials() {
            if (confirm('Are you sure you want to clear your Mixpanel credentials?')) {
                const sync = new window.MixpanelSync();
                sync.clearCredentials();
                
                document.getElementById('projectToken').value = '';
                document.getElementById('apiSecret').value = '';
                
                const testStatus = document.getElementById('testStatus');
                testStatus.className = 'test-status success';
                testStatus.textContent = 'Credentials cleared';
                testStatus.style.display = 'block';
                
                // Update status indicator
                updateCredentialsStatus();
                
                setTimeout(() => {
                    closeCredentialsModal();
                }, 1500);
            }
        }
        
        function updateCredentialsStatus() {
            const statusElement = document.getElementById('credentialsStatus');
            if (statusElement && window.MixpanelSync) {
                const sync = new window.MixpanelSync();
                if (sync.hasCredentials()) {
                    statusElement.innerHTML = `
                        <span style="color: #28a745;">✓ Mixpanel credentials configured</span>
                        <button onclick="showCredentialsModal()" style="margin-left: 10px; padding: 2px 8px; font-size: 11px; background: #6c757d; color: white; border: none; border-radius: 3px; cursor: pointer;">Update</button>
                    `;
                } else {
                    statusElement.innerHTML = `
                        <span style="color: #dc3545;">✗ Mixpanel credentials not configured</span>
                        <button onclick="showCredentialsModal()" style="margin-left: 10px; padding: 2px 8px; font-size: 11px; background: #6f42c1; color: white; border: none; border-radius: 3px; cursor: pointer;">Configure</button>
                    `;
                }
            }
        }
        
        // Make showCredentialsModal available globally
        window.showCredentialsModal = showCredentialsModal;
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('credentialsModal');
            if (event.target === modal) {
                closeCredentialsModal();
            }
        }
        
        // Update analysis_tool.js title function
        function updateAnalysisToolTitle() {
            // This function will be called after the tool is created
            const analysisHeader = document.querySelector('#analysisToolContainer .qda-header h3');
            if (analysisHeader) {
                analysisHeader.textContent = 'User Analysis Tool';
            }
        }
        
        // Use window.onload to ensure DOM and scripts are fully loaded
        window.onload = function() {
            // Data Merger: Initializes in its container
            createInlineDataMerger(document.getElementById('dataMergerContainer'));
            
            // Analysis Tool: Initializes its upload UI in the first container, 
            // and directs results to the separate output container.
            createWidget(
                document.getElementById('analysisToolContainer'), 
                document.getElementById('analysisResultsOutputContainer')
            );
            
            // Update the analysis tool title
            updateAnalysisToolTitle();
            
            // Update credentials status on load
            updateCredentialsStatus();
        };
    </script>
</body>
</html>